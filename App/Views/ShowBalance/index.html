{% extends 'base.html' %}

{% block title %}Your balance in Personal Budget{% endblock %}

{% block footer %}

	<script>
	window.onload = function() 
	{
		
		var chart_with_incomes = new CanvasJS.Chart("chartIncomesContainer", 
			{
				animationEnabled: true,
				title: 
				{
					text: "Summary of your incomes"
				},
				data: [
				{
					type: "doughnut",
					startAngle: 270,
					yValueFormatString: "##0.00\"\"",
					indexLabel: "{label} {y}",
					dataPoints: 
					[
						while ($incomes_by_categories
						
						
						
						{% for name, sum in incomes_by_categories %}
							<tr><td> {{ incomes_by_categories[loop.index0].name }} </td><td> {{ incomes_by_categories[loop.index0].sum }} </td></tr>
						{% endfor %}
						
						
						<?php
							while ($row_with_incomes = $_SESSION['result_incomes']->fetch_assoc())
							{
								$amount = $row_with_incomes['SUM(inc.amount)'];
								$name = $row_with_incomes['name'];
								echo "{y: " . $amount . ", label: \" $name \"},";
							}
							$_SESSION['result_incomes']->data_seek(0); 
						?>
					]
				}]
			});
			
		chart_with_incomes.render();
		
		var chart_with_expenses = new CanvasJS.Chart("chartExpensesContainer", 
			{
				animationEnabled: true,
				title: 
				{
					text: "Summary of your expenses"
				},
				data: [
				{
					
					type: "doughnut",
					startAngle: 270,
					yValueFormatString: "##0.00\"\"",
					indexLabel: "{label} {y}",
					dataPoints: 
					[
						<?php
							while ($row_with_expenses = $_SESSION['result_expenses']->fetch_assoc())
							{
								$amount = $row_with_expenses['SUM(exp.amount)'];
								$name = $row_with_expenses['name'];
								echo "{y: " . $amount . ", label: \" $name \"},";
							}
							$_SESSION['result_expenses']->data_seek(0); 
						?>
					]
				}]
			});
		chart_with_expenses.render();
	}
	</script>

{% endblock %}

{% block body %}	
	
		<fieldset class="border">
		
			<legend class="border bg-light"> Your finances </legend>
			
			<form method="post" action="/ShowBalance/show">
				<div class="input-group mb-2 w-75 mx-auto">
					<div class="input-group-prepend w-50">
						<span class="input-group-text w-100 justify-content-center">Select period of time</span>
					</div>
					<select id="periodsOptions" name="periodsOptions" class="w-50" onchange="if(this.options[this.selectedIndex].value!='custom'){ this.form.submit(); }">
						<option value="current_month">Current month</option>
						<option value="previous_month">Previous month</option>
						<option value="current_year">Current year</option>
						<option value="custom">Custom</option>
					</select>	
				</div>
			</form>
			
			<script>			
			$("#periodsOptions").on("change", function () {        
				$modal = $('#myModal');
				if($(this).val() === 'custom'){
					$modal.modal('show');
				}
			});
			</script>

			<div class="modal fade" id="myModal">
				<div class="modal-dialog">
					<div class="modal-content">
						<form method="post" action="/ShowBalance/show">
							<!-- Modal Header -->
							<div class="modal-header">
								<h4 class="modal-title">Select custom period of time: </h4>
								<button type="button" class="close" data-dismiss="modal">&times;</button>
							</div>
						
							<!-- Modal body -->
							<div class="modal-body">
								<div class="input-group mb-2 w-75">
									<div class="input-group-prepend w-25">
										<span class="input-group-text w-100 justify-content-center">Start:</span>
									</div>
									<input type="date" name="custom_start" class="form-control" required>
								</div>
								<div class="input-group mb-2 w-75">
									<div class="input-group-prepend w-25">
										<span class="input-group-text w-100 justify-content-center">End:</span>
									</div>
									<input type="date" name="custom_end" class="form-control" required>
								</div>
							</div>
						
							<!-- Modal footer -->
							<div class="modal-footer">
							<input type="submit" class="btn btn-info" name="customize_period" value="OK">
							<button type="button" class="btn btn-info" data-dismiss="modal">Cancel</button>
							</div>
						</form>
					</div>
				</div>
			</div>
			
			<fieldset class="border m-3">
			
				<legend class="border"> Your incomes </legend>
			  
				<div class="d-md-flex justify-content-around">
					<table class="table table-striped m-2 col-11 col-md-6">
						<thead>
							<tr>
								<th>Category</th>
								<th>Amount</th>
							</tr>
						</thead>
						<tbody>
				{% for name, sum in incomes_by_categories %}
					<tr><td> {{ incomes_by_categories[loop.index0].name }} </td><td> {{ incomes_by_categories[loop.index0].sum }} </td></tr>
				{% endfor %}
						<thead>
							 <tr>
								<th>Total</th>
								<th>{{ total_income.sum }}</th>
							</tr>
						</thead>
						</tbody>
					</table>
				
				</div>	
			</fieldset>
			
			{% for message in flash_messages %}
				<div>
					{{ message }}
				</div>
			{% endfor %}
		
			<fieldset class="border m-3">
			
				<legend class="border"> Your expenses </legend>
			  
				<div class="d-md-flex justify-content-around">
					<table class="table table-striped m-2 col-11 col-md-6">
						<thead>
							<tr>
								<th>Category</th>
								<th>Amount</th>
							</tr>
						</thead>
						<tbody>
				{% for name in expenses_by_categories %}
					<tr><td> {{ expenses_by_categories[loop.index0].name }} </td><td> {{ expenses_by_categories[loop.index0].sum }} </td></tr>
				{% endfor %}
						<thead>
							 <tr>
								<th>Total</th>
								<th>{{ total_expense.sum }}</th>
							</tr>
						</thead>
						</tbody>
					</table>
									

				</div>	
			</fieldset>
		</fieldset>	


{% endblock %}
